{% extends "base.html" %}
{% block maincontents %}


<div class="container" id ="head_title">


    <h1>安全信息查询</h1>


</div><!-- /.container -->

<div class="container-fluid">
    <button id="export-file" class="intext-btn">
        导出为csv文件
    </button>
    <br>
    <div id="example"></div>
</div><!-- /.container -->
<script>
var data = {{ json_data | safe}};
for (var i = 0; i < data.length; i++) {
        data[i]["相关附件"] = attachment(data[i]["相关附件"])
};
var container = document.getElementById('example');
var hot = new Handsontable(container, {
  data: data,
  dataSchema:{'日期':null, '地点':null, '时间':null, '受检单位':null},
  rowHeaders: true,
  colHeaders: ['日期', '地点', '时间', '受检单位', '责任班组', '信息来源', '问题分类', '事件等级', '问题描述', '整改措施', '处理意见', '关闭情况' , '相关附件'],
  columns: [
      {data: '日期',
       type: 'date',
       dateFormat: 'YYYY-MM-DD'},
      {data: '地点'},
      {data: '时间'},
      {data: '受检单位'},
      {data: '责任班组'},
      {data: '信息来源'},
      {data: '问题分类'},
      {data: '事件等级'},
      {data: '问题描述'},
      {data: '整改措施'},
      {data: '处理意见'},
      {data: '关闭情况'},
      {data: '相关附件',
        renderer: 'html',},
    ],
  dropdownMenu: true,
  readOnly: true,
  colWidths: [65, 65, 65, 88, 88, 88, 88, 88, 222, 202, 88, 88, 88],
  filters: true,
  height: getHeight()
});

function getHeight() {
        return $(window).height() - $('h1').outerHeight(true) * 2;
    }

function attachment(value) {
        var the_url;
        if (value == ""){
            return "无";
        }
        else{
            the_url = "/media/112233".replace("112233", value);
            return [
                '<a href="' + the_url + '" target="_blank">' + "查看" + '</a>'
            ].join('');
        }
    }

</script>
<script>
document.addEventListener("DOMContentLoaded", function() {

  var example1 = document.getElementById('example');
  
  
  
  var buttons = {
    file: document.getElementById('export-file')
  };
  
  var exportPlugin = hot.getPlugin('exportFile');
  hot.getPlugin('filters').addFormula(1, 'eq', ['211']);
hot.getPlugin('filters').filter();
    
  buttons.file.addEventListener('click', function() {
    exportPlugin.downloadFile('csv', 
        {
            filename: '安全信息',
            columnHeaders: true,
        }
    );
  });
  
  
  function bindDumpButton() {
      if (typeof Handsontable === "undefined") {
        return;
      }
  
      Handsontable.Dom.addEvent(document.body, 'click', function (e) {
  
        var element = e.target || e.srcElement;
  
        if (element.nodeName == "BUTTON" && element.name == 'dump') {
          var name = element.getAttribute('data-dump');
          var instance = element.getAttribute('data-instance');
          var hot = window[instance];
          console.log('data of ' + name, hot.getData());
        }
      });
    }
  bindDumpButton();
});
</script>
{% endblock %}